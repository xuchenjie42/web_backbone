(function() {
  'use strict';

  var merge = function(_) {
    var clone = function(o) {
      if(typeof o !== 'object') {
        return o;
      }

      return _.clone(o);
    };
    
    var merge = function() {
      var a = {};

      for(var i = 0, length = arguments.length; i < length; ++i) {
        var b = arguments[i];

        if(typeof b !== 'object' || b === null) {
          return b;
        }

        for(var x in b) {
          if(typeof b[x] === 'object') {
            if(typeof a[x] !== 'object') { a[x] = {}; }

            if(_.isArray(b[x])) {
              a[x] = _.isArray(a[x]) ? a[x] : [];
              for(var j = 0, y = b[x].length; j < y; ++j) {
                if(a[x].indexOf(b[x][j]) === -1) {
                  a[x].push(clone(b[x][j]));
                }
              }
            } else {
              a[x] = merge(a[x], clone(b[x])); 
            }
          } else {
            a[x] = b[x];
          }
        }
      }

      return a;
    };

    _.mixin({ merge: merge });
    
    return _;
  };

  if(typeof define === 'function' && define.amd) {
    define(['underscore'], function(_) {
      return merge(_);
    });
  } else if(typeof module !== 'undefined') {
    module.exports = merge(require('underscore'));
  }
})();