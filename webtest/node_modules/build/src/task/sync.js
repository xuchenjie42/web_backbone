'use strict';

var _ = require('underscore');
var argv = require('yargs').argv;
var fs = require('fs');
var run = require('run');
var Promise = require('promise');

module.exports = require('../task').extend({
  name: 'sync',
  repos: { self: './' },
  execute: function() {
    var git = argv.git || (!argv.bower && !argv.npm);
    var bower = argv.bower || ((!argv.git && !argv.npm));
    var npm = argv.npm || ((!argv.git && !argv.bower));
    
    var plugins = this.plugins;
    var promises = [Promise.resolve()];

    if(git && fs.existsSync('./.git')) {
      _.each(this.repos, function(path, key) {
        plugins.util.log('syncing...' + key + '[' + path + ']');
        promises.push(run('git', 'pull', {
          cwd: path
        }));
      });
    }

    Promise.all(promises).then(function() {
      var promises = [];
      //var promise = Promise.resolve();
      
      if(bower) {
        promises.push(run('bower', 'update'));
        // promise = promise.then(function() {
        //   return run('bower', 'update');
        // });
      }

      if(npm) {
        promises.push(run('npm', 'update'));
        // promise = promise.then(function() {
        //   return run('npm', 'update');
        // });
      }
      
      //return promise;
      return Promise.all(promises);
    });
  }
}, { export: 'Sync', config: ['repos'] });