'use strict';

var webpack = require('webpack');
var _ = require('underscore');

module.exports = require('../task').extend({
  name: 'js',
  execute: function(cb) {
    var me = this;

    this.resolve();

    webpack(this.webpack, function(err, stats) {
      if(err) {
        throw new me.plugins.util.PluginError('compile', err);
      }
      
      me.plugins.util.log('[compile]', stats.toString({
        colors: true
      }));
      cb();
    });
  },
  resolve: function() {
    if(this.webpack.plugins && !Array.isArray(this.webpack.plugins)) {
      this.webpack.plugins =
        _.values(_.map(this.webpack.plugins, function(value, key) {
          var pieces = key.split(/\./);
          var constructor = webpack[pieces[0]];
      
          for(var i = 1, length = pieces.length; i < length; ++i) {
            constructor = constructor[pieces[i]];
            if(!constructor) { break; }
          }
      
          if(!constructor) { return null; }
      
          var factory = constructor.bind.apply(constructor, [null].concat(value));
      
          return new factory();
      }));
    }
  }
}, { export: 'JS', config: ['webpack'] });